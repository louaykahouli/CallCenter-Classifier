name: ğŸš€ CI/CD Pipeline - Full Stack Testing

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  REGISTRY: docker.io
  IMAGE_CALLCENTER: "maalejala/callcenter"
  IMAGE_TFIDF: "maalejala/tfidf-svm"
  IMAGE_AGENT: "maalejala/ia-agent"

jobs:
  # ============================================================================
  # 1ï¸âƒ£ FRONTEND TESTS (React/Node.js)
  # ============================================================================
  frontend-tests:
    runs-on: ubuntu-latest
    name: ğŸ¨ Frontend Lint & Tests

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: 'ia_agent/frontend/package-lock.json'

    - name: Install frontend dependencies
      run: npm ci
      working-directory: ./ia_agent/frontend

    - name: ğŸ” Lint frontend (ESLint)
      run: npx eslint "src/**/*.{js,jsx}" --format=compact
      working-directory: ./ia_agent/frontend
      continue-on-error: false

    - name: ğŸ§ª Run frontend unit tests
      run: npm test -- --watchAll=false --coverage --passWithNoTests
      working-directory: ./ia_agent/frontend
      continue-on-error: true

    - name: ğŸ“¦ Build frontend
      run: npm run build
      working-directory: ./ia_agent/frontend

  # ============================================================================
  # 2ï¸âƒ£ PYTHON BACKEND TESTS (All services)
  # ============================================================================
  backend-tests:
    runs-on: ubuntu-latest
    name: ğŸ Backend Unit & Integration Tests

    strategy:
      matrix:
        service:
          - path: "./Transformer/Transformer"
            name: "Transformer API"
          - path: "./tfidf_svm"
            name: "TF-IDF SVM"
          - path: "./ia_agent"
            name: "IA Agent Router"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies for ${{ matrix.service.name }}
      run: |
        python -m pip install --upgrade pip
        if [ -f "${{ matrix.service.path }}/requirements.txt" ]; then
          pip install -r "${{ matrix.service.path }}/requirements.txt"
        fi
        if [ -f "${{ matrix.service.path }}/requirements-test.txt" ]; then
          pip install -r "${{ matrix.service.path }}/requirements-test.txt"
        fi

    - name: ğŸ” Lint Python code (${{ matrix.service.name }})
      run: |
        pip install flake8 pylint
        flake8 ${{ matrix.service.path }}/src ${{ matrix.service.path }}/api.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
        pylint ${{ matrix.service.path }}/src ${{ matrix.service.path }}/api.py --disable=all --enable=E,F || true
      continue-on-error: true

    - name: ğŸ§ª Run tests (${{ matrix.service.name }})
      run: |
        if [ -d "${{ matrix.service.path }}/tests" ]; then
          pytest ${{ matrix.service.path }}/tests -v --tb=short --junit-xml=test-results.xml || true
        fi
        if [ -f "${{ matrix.service.path }}/test_complete.py" ]; then
          pytest ${{ matrix.service.path }}/test_complete.py -v --tb=short || true
        fi
      continue-on-error: true

  # ============================================================================
  # 3ï¸âƒ£ DOCKER BUILD - Multiple Images
  # ============================================================================
  docker-build:
    runs-on: ubuntu-latest
    name: ğŸ³ Build Docker Images
    needs: [frontend-tests, backend-tests]

    strategy:
      matrix:
        image:
          - dockerfile: "Dockerfile"
            context: "."
            tag: "maalejala/callcenter:latest"
            name: "CallCenter (Transformer + MLflow)"
          - dockerfile: "tfidf_svm/Dockerfile.api"
            context: "tfidf_svm"
            tag: "maalejala/tfidf-svm:latest"
            name: "TF-IDF SVM API"
          - dockerfile: "ia_agent/Dockerfile"
            context: "ia_agent"
            tag: "maalejala/ia-agent:latest"
            name: "IA Agent Router"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: github.event_name == 'push'

    - name: ğŸ—ï¸ Build ${{ matrix.image.name }}
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.image.context }}
        dockerfile: ${{ matrix.image.dockerfile }}
        push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
        tags: ${{ matrix.image.tag }}
        cache-from: type=registry,ref=${{ matrix.image.tag }}
        cache-to: type=inline

  # ============================================================================
  # 4ï¸âƒ£ SECURITY SCANNING
  # ============================================================================
  security-scan:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Scanning (Trivy + Dependency Check)
    needs: docker-build

    strategy:
      matrix:
        image:
          - name: "CallCenter"
            tag: "maalejala/callcenter:latest"
          - name: "TF-IDF SVM"
            tag: "maalejala/tfidf-svm:latest"
          - name: "IA Agent"
            tag: "maalejala/ia-agent:latest"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: ğŸ” Run Trivy vulnerability scanner on ${{ matrix.image.name }}
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ matrix.image.tag }}
        format: 'sarif'
        output: 'trivy-${{ matrix.image.name }}.sarif'
        severity: 'HIGH,CRITICAL'
      continue-on-error: true

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-${{ matrix.image.name }}.sarif'
        category: 'trivy-${{ matrix.image.name }}'
      continue-on-error: true

    - name: ğŸ“‹ Scan Dependencies for vulnerabilities
      run: |
        pip install safety
        safety check --json || true

  # ============================================================================
  # 5ï¸âƒ£ CODE QUALITY & ANALYSIS
  # ============================================================================
  code-quality:
    runs-on: ubuntu-latest
    name: ğŸ“Š Code Quality Analysis

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: ğŸ” SonarQube Analysis (Optional - if secrets configured)
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      if: ${{ secrets.SONAR_TOKEN != null }}
      continue-on-error: true

    - name: ğŸ“ˆ Check code formatting (Black - Python)
      run: |
        pip install black
        black --check Transformer/Transformer/api Transformer/Transformer/src tfidf_svm/src ia_agent || true
      continue-on-error: true

  # ============================================================================
  # 6ï¸âƒ£ DOCKER COMPOSE INTEGRATION TEST
  # ============================================================================
  integration-test:
    runs-on: ubuntu-latest
    name: ğŸ§ª Docker Compose Integration Test
    needs: docker-build

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ³ Start Docker Compose stack
      run: |
        docker compose up -d --wait
        sleep 10
      timeout-minutes: 5

    - name: âœ… Health checks - API endpoints
      run: |
        echo "ğŸ” Testing CallCenter API (8000)..."
        curl -f http://localhost:8000/health || exit 1
        
        echo "ğŸ” Testing TF-IDF SVM API (8001)..."
        curl -f http://localhost:8001/health || exit 1
        
        echo "ğŸ” Testing IA Agent API (8002)..."
        curl -f http://localhost:8002/health || exit 1
        
        echo "ğŸ” Testing Prometheus (9090)..."
        curl -f http://localhost:9090/-/healthy || exit 1
      timeout-minutes: 2

    - name: ğŸ“ Test classification endpoint
      run: |
        curl -X POST http://localhost:8002/classify \
          -H "Content-Type: application/json" \
          -d '{"text":"Mon ordinateur ne dÃ©marre plus"}' \
          -f || exit 1
      timeout-minutes: 2

    - name: ğŸ“Š Verify Prometheus scraping
      run: |
        TARGETS=$(curl -s http://localhost:9090/api/v1/targets | grep -o '"state":"up"' | wc -l)
        echo "Active Prometheus targets: $TARGETS"
        if [ "$TARGETS" -lt 1 ]; then exit 1; fi

    - name: ğŸ§¹ Cleanup Docker stack
      run: docker compose down -v
      if: always()

  # ============================================================================
  # 7ï¸âƒ£ DEPLOYMENT (Conditional - only on main push)
  # ============================================================================
  deploy:
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Production
    needs: [frontend-tests, backend-tests, security-scan, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: ğŸ¯ Log deployment info
      run: |
        echo "âœ… All tests passed!"
        echo "ğŸ“¦ Ready to deploy:"
        echo "  - maalejala/callcenter:latest"
        echo "  - maalejala/tfidf-svm:latest"
        echo "  - maalejala/ia-agent:latest"

    - name: ğŸ“¢ Notify deployment
      run: |
        echo "ğŸš€ Deployment notification would go here"
        echo "You can integrate with Slack, Email, or your deployment platform"

  # ============================================================================
  # ğŸ“Š SUMMARY JOB
  # ============================================================================
  summary:
    runs-on: ubuntu-latest
    name: ğŸ“Š CI/CD Summary
    if: always()
    needs: [frontend-tests, backend-tests, docker-build, security-scan, code-quality, integration-test]

    steps:
    - name: ğŸ“‹ Print CI/CD Summary
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘         ğŸ¯ CI/CD PIPELINE EXECUTION SUMMARY            â•‘"
        echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
        echo "â•‘ âœ… Frontend Tests:        ${{ needs.frontend-tests.result }}"
        echo "â•‘ âœ… Backend Tests:         ${{ needs.backend-tests.result }}"
        echo "â•‘ ğŸ³ Docker Build:         ${{ needs.docker-build.result }}"
        echo "â•‘ ğŸ”’ Security Scan:        ${{ needs.security-scan.result }}"
        echo "â•‘ ğŸ“Š Code Quality:         ${{ needs.code-quality.result }}"
        echo "â•‘ ğŸ§ª Integration Tests:    ${{ needs.integration-test.result }}"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
